generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"] // Habilita suporte a Views do SQL
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================
// ENUMS
// ==============================

enum UserRole {
  owner
  partner
}

enum AccountStatus {
  active
  pending_partner
  inactive
}

enum TransactionType {
  income
  expense
}

enum PaymentMethod {
  cash
  pix
  card
  sale
}

enum AccountType {
  wallet
  bank
}

enum CurrencyCode {
  BRL
  USD
  EUR
}

enum AlertFrequency {
  daily
  interval
  weekly
  percentage
}

enum OauthProvider {
  google
  github
}

// ==============================
// MODELS (TABELAS)
// ==============================

model User {
  id                       String    @id @default(uuid()) @db.Uuid
  email                    String    @unique
  passwordHash             String?   @map("password_hash")
  emailVerified            Boolean   @default(false) @map("email_verified")
  emailVerificationToken   String?   @map("email_verification_token")
  emailVerificationExpires DateTime? @map("email_verification_expires_at") @db.Timestamptz

  oauthProvider   OauthProvider? @map("oauth_provider")
  oauthProviderId String?        @map("oauth_provider_id")

  name              String
  nickname          String?
  nicknameChangedAt DateTime? @map("nickname_changed_at") @db.Timestamptz
  nicknameChangedBy String?   @map("nickname_changed_by") @db.Uuid

  avatarUrl  String? @map("avatar_url")
  avatarType String? @default("predefined") @map("avatar_type")

  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz

  // Relacionamentos
  accountMembers      AccountMember[]
  financialAccounts   FinancialAccount[]
  transactions        Transaction[]
  passwordResetTokens PasswordResetToken[]
  auditLogs           AuditLog[]

  @@index([email])
  @@index([oauthProvider, oauthProviderId])
  @@map("users")
}

model Account {
  id              String        @id @default(uuid()) @db.Uuid
  status          AccountStatus @default(pending_partner)
  defaultCurrency CurrencyCode  @default(BRL) @map("default_currency")

  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  activatedAt DateTime? @map("activated_at") @db.Timestamptz

  // Relacionamentos
  members           AccountMember[]
  categories        Category[]
  financialAccounts FinancialAccount[]
  transactions      Transaction[]
  budgets           Budget[]
  auditLogs         AuditLog[]

  // View Relations (Opcional, para tipagem)
  // accountBalances AccountBalance? 

  @@map("accounts")
}

model AccountMember {
  id        String   @id @default(uuid()) @db.Uuid
  accountId String   @map("account_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      UserRole

  invitationToken      String?   @map("invitation_token")
  invitationSentAt     DateTime? @map("invitation_sent_at") @db.Timestamptz
  invitationAcceptedAt DateTime? @map("invitation_accepted_at") @db.Timestamptz

  joinedAt DateTime @default(now()) @map("joined_at") @db.Timestamptz

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@index([accountId])
  @@index([userId])
  @@index([invitationToken])
  @@map("account_members")
}

model Category {
  id              String          @id @default(uuid()) @db.Uuid
  accountId       String          @map("account_id") @db.Uuid
  name            String
  color           String
  icon            String?
  transactionType TransactionType @map("transaction_type")
  displayOrder    Int             @default(0) @map("display_order")
  isActive        Boolean         @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets      Budget[]

  @@unique([accountId, name, transactionType])
  @@index([accountId])
  @@index([transactionType])
  @@map("categories")
}

model FinancialAccount {
  id        String  @id @default(uuid()) @db.Uuid
  accountId String  @map("account_id") @db.Uuid
  userId    String? @map("user_id") @db.Uuid

  name           String
  type           AccountType
  balance        Decimal     @default(0.00) @db.Decimal(15, 2)
  initialBalance Decimal     @default(0.00) @map("initial_balance") @db.Decimal(15, 2)

  bankName String? @map("bank_name")
  bankCode String? @map("bank_code")

  currency       CurrencyCode @default(BRL)
  isActive       Boolean      @default(true) @map("is_active")
  includeInTotal Boolean      @default(true) @map("include_in_total")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id])
  transactions Transaction[]

  @@index([accountId])
  @@index([userId])
  @@map("financial_accounts")
}

model Transaction {
  id                 String  @id @default(uuid()) @db.Uuid
  accountId          String  @map("account_id") @db.Uuid
  userId             String  @map("user_id") @db.Uuid
  categoryId         String? @map("category_id") @db.Uuid
  financialAccountId String? @map("financial_account_id") @db.Uuid

  type          TransactionType
  name          String
  description   String?         @db.Text
  amount        Decimal         @db.Decimal(15, 2)
  currency      CurrencyCode    @default(BRL)
  paymentMethod PaymentMethod?  @map("payment_method")

  entryDate     DateTime @map("entry_date") @db.Date
  effectiveDate DateTime @map("effective_date") @db.Date
  isEffective   Boolean  @default(false) @map("is_effective")

  isRecurring       Boolean @default(false) @map("is_recurring")
  recurrencePattern String? @map("recurrence_pattern")
  notes             String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  account          Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id])
  category         Category?         @relation(fields: [categoryId], references: [id])
  financialAccount FinancialAccount? @relation(fields: [financialAccountId], references: [id])

  @@index([accountId])
  @@index([userId])
  @@index([categoryId])
  @@index([financialAccountId])
  @@index([type])
  @@index([entryDate, effectiveDate])
  @@index([isEffective])
  @@map("transactions")
}

model Budget {
  id         String  @id @default(uuid()) @db.Uuid
  accountId  String  @map("account_id") @db.Uuid
  categoryId String? @map("category_id") @db.Uuid

  name         String
  targetAmount Decimal  @map("target_amount") @db.Decimal(15, 2)
  startDate    DateTime @map("start_date") @db.Date
  endDate      DateTime @map("end_date") @db.Date

  enableAlerts      Boolean         @default(false) @map("enable_alerts")
  alertFrequency    AlertFrequency? @map("alert_frequency")
  alertIntervalDays Int?            @map("alert_interval_days")
  alertPercentage   Int?            @map("alert_percentage")

  includeInForecast Boolean @default(true) @map("include_in_forecast")
  isActive          Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id])
  budgetAlerts BudgetAlert[]

  @@index([accountId])
  @@index([categoryId])
  @@index([startDate, endDate])
  @@map("budgets")
}

model BudgetAlert {
  id       String @id @default(uuid()) @db.Uuid
  budgetId String @map("budget_id") @db.Uuid

  alertType String @map("alert_type")
  message   String @db.Text

  spentAmount    Decimal @map("spent_amount") @db.Decimal(15, 2)
  targetAmount   Decimal @map("target_amount") @db.Decimal(15, 2)
  percentageUsed Decimal @map("percentage_used") @db.Decimal(5, 2)

  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([isRead])
  @@map("budget_alerts")
}

model PredefinedAvatar {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  url          String
  category     String?
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([isActive])
  @@map("predefined_avatars")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  used      Boolean   @default(false)
  usedAt    DateTime? @map("used_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model AuditLog {
  id        String  @id @default(uuid()) @db.Uuid
  accountId String? @map("account_id") @db.Uuid
  userId    String? @map("user_id") @db.Uuid

  action     String
  entityType String  @map("entity_type")
  entityId   String? @map("entity_id") @db.Uuid

  oldData Json? @map("old_data")
  newData Json? @map("new_data")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  account Account? @relation(fields: [accountId], references: [id])
  user    User?    @relation(fields: [userId], references: [id])

  @@index([accountId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==============================
// VIEWS (Requer previewFeatures = ["views"])
// ==============================
// O Prisma não cria views automaticamente, você deve criá-las via SQL Migration
// Mas você pode defini-las aqui para ter tipagem no TypeScript

view AccountBalance {
  accountId     String  @unique @map("account_id") @db.Uuid
  totalBalance  Decimal @map("total_balance") @db.Decimal(15, 2)
  walletBalance Decimal @map("wallet_balance") @db.Decimal(15, 2)
  bankBalance   Decimal @map("bank_balance") @db.Decimal(15, 2)

  @@map("account_balances")
}
